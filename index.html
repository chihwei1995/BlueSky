<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Blue Sky Returns</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- âœ… å…ˆè¼‰ THREEï¼ˆåªè¼‰ä¸€æ¬¡ï¼‰ -->
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <!-- âœ… å†è¼‰ globe.gl -->
  <script src="https://unpkg.com/globe.gl"></script>

  <!-- IG embedï¼ˆå¯é¸ï¼‰ -->
  <script async src="//www.instagram.com/embed.js"></script>

  <style>
    :root {
      --color-crisis: #FF4D4D;
      --color-hope: #00D2FF;
      --color-hope-alt: #2ECC40;
      --bg-glass: rgba(15, 20, 30, 0.7);
      --panel-shadow: 0 20px 50px rgba(0, 0, 0, 0.45);

      /* âœ… æ‰‹æ©Ÿåº•éƒ¨è³‡è¨Šåˆ—é ç•™é«˜åº¦ï¼ˆé¿å…ä¸Šæ–¹é¢æ¿æ“ ä¸‹å»æ™‚æ’åˆ°åº•éƒ¨ï¼‰ */
      --mobile-info-reserve: 120px;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      overflow: hidden;
      background: radial-gradient(circle at 20% 20%, rgba(0, 210, 255, 0.15), transparent 35%),
                  radial-gradient(circle at 80% 10%, rgba(255, 77, 77, 0.25), transparent 30%),
                  #030712;
      color: #f6f7fb;
    }
    a { color: inherit; text-decoration: none; }

    #globe-container { position: fixed; inset: 0; pointer-events: auto; }
    #globeViz { width: 100vw; height: 100vh; }

    #modeOverlay{
      position: fixed; inset: 0; pointer-events: none;
      opacity: 0.0;
      transition: opacity 0.6s ease, background 0.6s ease, filter 0.6s ease;
      mix-blend-mode: screen;
      filter: saturate(1.05) contrast(1.05);
      z-index: 1;
    }
    body[data-mode="crisis"] #modeOverlay{
      opacity: 0.28;
      background:
        radial-gradient(circle at 20% 10%, rgba(255,77,77,0.55), transparent 42%),
        radial-gradient(circle at 80% 20%, rgba(255,140,0,0.22), transparent 40%),
        radial-gradient(circle at 50% 70%, rgba(255,77,77,0.12), transparent 55%);
    }
    body[data-mode="hope"] #modeOverlay{
      opacity: 0.22;
      background:
        radial-gradient(circle at 30% 20%, rgba(0,210,255,0.55), transparent 45%),
        radial-gradient(circle at 75% 30%, rgba(46,204,64,0.22), transparent 40%),
        radial-gradient(circle at 50% 75%, rgba(0,210,255,0.10), transparent 55%);
    }

    #ui-layer {
      position: fixed; inset: 0;
      display: flex; flex-direction: column; justify-content: space-between;
      pointer-events: none;
      padding: 16px;
      z-index: 2;
    }

    header {
      display: flex; justify-content: space-between; align-items: center; gap: 12px;
      padding: 12px 16px;
      background: linear-gradient(to bottom, rgba(0,0,0,0.7), rgba(0,0,0,0));
      border-radius: 16px;
      pointer-events: auto;
      flex-wrap: wrap;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

       /* é»æ“Š logo ä»ç¶­æŒåƒæ¨™é¡Œï¼Œä¸è¦åº•ç·š */
    .logo { 
      display: flex; 
      align-items: center; 
      gap: 10px; 
      font-weight: 700; 
      letter-spacing: 1px; 
      pointer-events: auto;
      text-decoration: none;
    }
    
    /* âœ… Blue Sky Returns æ”¹ç™½å­— */
    .logo .logo-text { 
      color: #ffffff; 
    }
    
    .logo-area {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* PJC logo åœ–æ¨£å¤§å°ï¼ˆå¯è‡ªè¡Œèª¿ï¼‰ */
    .pjc-logo{
      width: 40px;
      height: 40px;
      object-fit: contain;
      border-radius: 8px;
    }

    .logo-divider {
      color: rgba(255, 255, 255, 0.65);
      font-weight: 600;
    }

    .about-link {
      font-weight: 600;
      color: #ffffff;
      letter-spacing: 0.5px;
      padding: 4px 6px;
      border-radius: 999px;
      transition: background 0.2s ease, color 0.2s ease;
    }

    .about-link:hover {
      background: rgba(255, 255, 255, 0.12);
    }
    
    /* hover å°æ•ˆæœï¼ˆå¯é¸ï¼‰ */
    .logo:hover { opacity: 0.92; }


    .ghost-btn {
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.05);
      color: #e5e7f2;
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 700;
      letter-spacing: 0.3px;
      cursor: pointer;
      transition: all 0.25s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: var(--panel-shadow);
    }

    .ghost-btn:hover { transform: translateY(-1px); background: rgba(255,255,255,0.10); }

    .anchor-panel {
      position: fixed;
      right: 18px;
      top: 100px;
      width: 380px;
      max-height: calc(100vh - 140px);
      display: flex;
      flex-direction: column;
      background: var(--bg-glass);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 18px;
      padding: 16px;
      box-shadow: var(--panel-shadow);
      backdrop-filter: blur(14px);
      overflow: hidden;
      transform: translateY(-8px);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease, transform 0.3s ease;
      z-index: 4;
    }

    .anchor-panel.show {
      transform: translateY(0);
      opacity: 1;
      pointer-events: auto;
    }

    .anchor-panel-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 12px;
    }

    .anchor-panel-title {
      font-weight: 800;
      letter-spacing: 0.6px;
      margin: 0;
    }

    .anchor-panel-sub {
      margin: 4px 0 0 0;
      color: #a8b2d8;
      font-size: 0.9rem;
    }

    .anchor-list {
      flex: 1 1 auto;
      overflow-y: auto;
      max-height: calc(100% - 42px);
      -webkit-overflow-scrolling: touch;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding-right: 4px;
    }

    .anchor-card {
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      padding: 12px;
      background: rgba(255,255,255,0.03);
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      transition: border 0.2s ease, transform 0.2s ease;
    }

    .anchor-card:hover { border-color: rgba(255,255,255,0.16); transform: translateY(-1px); }

    .anchor-heading { margin: 0; font-size: 1rem; }
    .anchor-meta { color: #9aa2c3; font-size: 0.9rem; margin: 4px 0; }
    .anchor-points { margin: 0; color: #dfe4ff; font-size: 0.92rem; line-height: 1.45; }
    .anchor-actions { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; justify-content: flex-end; }
    .anchor-ig-section { grid-column: 1 / -1; display: flex; flex-direction: column; gap: 10px; margin-top: 6px; }
    .anchor-ig-scroll { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 6px; }
    .anchor-ig-card { flex: 0 0 320px; max-width: 320px; }
    .anchor-ig-card.hidden { display: none; }
    .anchor-ig-toggle { align-self: flex-start; }

    .tiny-btn {
      background: rgba(255,255,255,0.08);
      color: #e5e7f2;
      border: 1px solid rgba(255,255,255,0.16);
      border-radius: 10px;
      padding: 8px 10px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .tiny-btn:hover { background: rgba(255,255,255,0.14); }

    .qr-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
      z-index: 6;
      padding: 20px;
    }

    .qr-modal.show { opacity: 1; pointer-events: auto; }

    .qr-card {
      background: #0a0f1c;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 18px;
      max-width: 360px;
      text-align: center;
      color: #e5e7f2;
      box-shadow: var(--panel-shadow);
    }

    .qr-card img {
      width: 240px;
      height: 240px;
      object-fit: contain;
      background: #fff;
      border-radius: 12px;
      padding: 8px;
      box-shadow: inset 0 1px 0 rgba(0,0,0,0.1);
    }

    .qr-card .tiny-btn { width: 100%; justify-content: center; margin-top: 12px; }

    .toggle-container {
      display: inline-flex;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 999px;
      padding: 4px;
      gap: 6px;
      box-shadow: var(--panel-shadow);
    }
    .toggle-btn {
      border: none;
      padding: 10px 16px;
      border-radius: 999px;
      cursor: pointer;
      color: #d6d8e2;
      background: transparent;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .toggle-btn.active[data-mode="crisis"] {
      background: radial-gradient(circle at 20% 20%, rgba(255,77,77,0.9), rgba(255,77,77,0.7));
      box-shadow: 0 10px 25px rgba(255,77,77,0.35);
      color: #fff;
    }
    .toggle-btn.active[data-mode="hope"] {
      background: linear-gradient(120deg, var(--color-hope), var(--color-hope-alt));
      box-shadow: 0 10px 25px rgba(0,210,255,0.35);
      color: #0b1020;
    }

    .lang-toggle {
      display: inline-flex;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 999px;
      padding: 4px;
      gap: 6px;
      box-shadow: var(--panel-shadow);
    }

    .lang-btn {
      border: none;
      padding: 8px 12px;
      border-radius: 999px;
      cursor: pointer;
      color: #d6d8e2;
      background: transparent;
      font-weight: 600;
      transition: all 0.25s ease;
    }

    .lang-btn.active {
      background: rgba(255,255,255,0.9);
      color: #0b1020;
      box-shadow: 0 8px 18px rgba(0,0,0,0.25);
    }

    .info-card {
      position: absolute;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      width: 360px;
      background: var(--bg-glass);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 18px;
      padding: 20px;
      box-shadow: var(--panel-shadow);
      opacity: 0;
      pointer-events: none;
      transition: transform 0.45s ease, opacity 0.45s ease;
      backdrop-filter: blur(16px);
      z-index: 4;
    }
    .info-card.show { opacity: 1; pointer-events: auto; transform: translateY(-50%) translateY(0); }
    .info-card.collapsed { padding: 14px 16px; }
    .info-card.collapsed .info-body { display: none; }

    .info-header { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .info-header-left { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .tag { padding: 6px 10px; border-radius: 10px; font-size: 0.8rem; font-weight: 700; letter-spacing: 0.4px; text-transform: uppercase; }
    .tag.crisis { background: rgba(255,77,77,0.2); color: var(--color-crisis); }
    .tag.hope { background: rgba(0,210,255,0.2); color: var(--color-hope); }

    h2 { margin: 10px 0 6px 0; font-size: 1.35rem; }
    .subtitle { color: #9aa2c3; font-size: 0.9rem; margin-bottom: 8px; }
    p { margin: 0 0 12px 0; color: #e7e9f4; line-height: 1.5; }

    .collapse-btn {
      background: rgba(255,255,255,0.06);
      color: #d6d8e2;
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 10px;
      padding: 8px 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      pointer-events: auto;
      white-space: nowrap;
    }

    .stats { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 10px; margin: 14px 0; }
    .stat-pill { background: rgba(255,255,255,0.06); border-radius: 12px; padding: 10px; font-size: 0.85rem; }
    .stat-label { opacity: 0.7; font-size: 0.78rem; }
    .media-area { border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; overflow: hidden; background: rgba(0,0,0,0.35); min-height: 150px; }
    .media-area img { width: 100%; display: block; object-fit: cover; }

    .timeline-container {
      pointer-events: auto;
      background: linear-gradient(to top, rgba(3,7,18,0.92), transparent);
      padding: 16px 12px 10px;
      border-radius: 18px 18px 12px 12px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.05);
      z-index: 3;
    }
    .timeline-label-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; flex-wrap: wrap; }
    .timeline-label { text-align: center; font-weight: 700; letter-spacing: 1px; margin-bottom: 10px; color: #dce2ff; }
    .year-select {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.14);
      color: #dce2ff;
      border-radius: 10px;
      padding: 8px 10px;
      font-weight: 600;
      min-width: 140px;
      cursor: pointer;
    }

    /* âœ… æ”¶åˆæ™‚åªè—å…§å®¹åˆ—ï¼Œä¸å½±éŸ¿æ¨™é¡Œåˆ— */
    .timeline-container.collapsed .timeline { display: none; }
    .timeline-container.collapsed .timeline-label { margin-bottom: 0; }

    .timeline { display: flex; justify-content: flex-start; gap: 10px; overflow-x: auto; padding-bottom: 8px; }
    .pill-btn {
      border: 1px solid rgba(255,255,255,0.14);
      color: #cbd3f6;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(255,255,255,0.03);
      cursor: pointer;
      min-width: 68px;
      text-align: center;
      transition: all 0.25s ease;
      flex: 0 0 auto;
      user-select: none;
    }
    .pill-btn.active {
      color: #fff;
      font-weight: 700;
      transform: translateY(-2px);
      box-shadow: 0 8px 18px rgba(0,0,0,0.35), 0 0 0 1px rgba(255,255,255,0.08);
    }
    .pill-btn[data-mode="crisis"].active { background: rgba(255,77,77,0.18); }
    .pill-btn[data-mode="hope"].active { background: rgba(0,210,255,0.18); }

    .badge { font-size: 0.75rem; padding: 4px 8px; border-radius: 8px; background: rgba(255,255,255,0.08); }

    #entryOverlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at 40% 30%, rgba(0,210,255,0.12), transparent 45%), rgba(3,7,18,0.92);
      opacity: 0;
      transition: opacity 1s ease;
      z-index: 8;
      pointer-events: none;
    }
    #entryOverlay.show { opacity: 1; }
    #entryOverlay.fade-out { opacity: 0; }
    #entryOverlay img {
      width: min(380px, 80vw);
      height: auto;
      object-fit: contain;
      filter: drop-shadow(0 8px 24px rgba(0,0,0,0.6));
    }

    @media (max-width: 768px) {
      #ui-layer{
        /* âœ… iOS safe-area */
        padding:
          calc(8px + env(safe-area-inset-top))
          calc(8px + env(safe-area-inset-right))
          calc(8px + env(safe-area-inset-bottom))
          calc(8px + env(safe-area-inset-left));
      }

      header { flex-direction: column; align-items: flex-start; }

      /* âœ… æ‰‹æ©Ÿï¼šæ™‚é–“è¡¨å›ºå®šä¸Šæ–¹ï¼Œä½†ã€Œé«˜åº¦å—é™ã€ä¸”å…§å®¹å¯æ»¾å‹• â†’ ä¸å†æ’åˆ°åº•éƒ¨è³‡è¨Š */
      .timeline-container {
        position: fixed;
        left: calc(8px + env(safe-area-inset-left));
        right: calc(8px + env(safe-area-inset-right));
        top: calc(100px + env(safe-area-inset-top));
        bottom: auto;
        z-index: 3;
        padding: 12px 10px 10px;
        border-radius: 16px;

        /* é—œéµï¼šæœ€å¤§é«˜åº¦ = ç•«é¢ - (header top) - åº•éƒ¨é ç•™ */
        max-height: calc(
          100vh
          - (70px + env(safe-area-inset-top))
          - (var(--mobile-info-reserve) + env(safe-area-inset-bottom))
          - 14px
        );

        overflow: hidden;
      }

      /* âœ… è®“é¢æ¿å…§å®¹å€å¯å‚ç›´æ»¾å‹•ï¼ˆé¿å…é¢æ¿è®Šé«˜å»æ’åº•éƒ¨ï¼‰ */
      .timeline-scroll {
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        padding-bottom: 6px;
      }

      .timeline-container.collapsed {
        max-height: 58px;
      }

      /* âœ… æ‰‹æ©Ÿï¼šinfo å›ºå®šä¸‹æ–¹ */
      .info-card {
        position: fixed;
        left: calc(8px + env(safe-area-inset-left));
        right: calc(8px + env(safe-area-inset-right));
        top: auto;
        bottom: calc(8px + env(safe-area-inset-bottom));
        width: auto;
        transform: translateY(120%);
        border-radius: 18px 18px 12px 12px;
        max-height: 60vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        z-index: 4;
      }
      .info-card.show { transform: translateY(0); }
      .info-body {
        flex: 1 1 auto;
        overflow-y: auto;
        padding-right: 4px;
        margin-top: 8px;
      }

      .stats { grid-template-columns: 1fr; }
      #globe-container { transform: translateY(-12%); }
      header { border-radius: 14px; }

      .anchor-panel {
        position: fixed;
        top: auto;
        bottom: calc(14px + env(safe-area-inset-bottom));
        right: calc(8px + env(safe-area-inset-right));
        left: calc(8px + env(safe-area-inset-left));
        width: auto;
        max-height: 48vh;
        z-index: 5;
      }

      .qr-card img { width: 200px; height: 200px; }
    }
  </style>
</head>

<body data-mode="crisis">
  <div id="entryOverlay" aria-hidden="true">
    <img src="Enter.PNG" alt="Enter illustration">
  </div>
  <div id="globe-container">
    <div id="globeViz"></div>
    <div id="modeOverlay" aria-hidden="true"></div>
  </div>

  <div id="ui-layer">
    <header>
      
        <div class="logo-area">
          <a class="logo" href="https://hkpjc.org/" target="_blank" rel="noopener noreferrer" data-i18n-aria-label="aria.pjcSite">
            <img src="PJC_LOGO.PNG" alt="PJC logo" class="pjc-logo" />
            <span class="logo-text">Blue Sky Returns</span>
          </a>
          <span class="logo-divider" aria-hidden="true">ï½œ</span>
          <a class="about-link" href="blueskyreturns/index.html" data-i18n="header.about" data-i18n-aria-label="aria.about">About</a>
        </div>

      <div class="header-actions">
        <button class="ghost-btn" id="anchorToggle" type="button" data-i18n="header.timeline">ğŸ“Œ Timeline</button>
        <div class="toggle-container" data-i18n-aria-label="aria.modeToggle">
          <button class="toggle-btn active" data-mode="crisis" id="btn-crisis" data-i18n="mode.crisis">âš ï¸ CRISIS</button>
          <button class="toggle-btn" data-mode="hope" id="btn-hope" data-i18n="mode.hope">ğŸŒ HOPE</button>
        </div>
        <div class="lang-toggle" role="group" data-i18n-aria-label="aria.languageToggle">
          <button class="lang-btn active" data-lang="en" type="button">EN</button>
          <button class="lang-btn" data-lang="zh" type="button">ä¸­æ–‡</button>
        </div>
      </div>
    </header>

    <div class="info-card" id="infoPanel" aria-live="polite">
      <div class="info-header">
        <div class="info-header-left">
          <span class="tag crisis" id="infoTag">CRISIS</span>
          <span class="badge" id="infoDate">--</span>
        </div>
        <button class="collapse-btn" id="infoCollapseBtn" type="button" aria-expanded="true" data-i18n="info.collapse">Collapse info</button>
      </div>
      <div class="info-body" id="infoBody">
        <h2 id="infoTitle" data-i18n="info.loading">Loading...</h2>
        <div class="subtitle" id="infoSubtitle">---</div>
        <p id="infoDesc">---</p>
        <div class="stats" id="statList"></div>
        <div class="media-area" id="mediaContainer"></div>
      </div>
    </div>

    <div class="timeline-container" id="timelineContainer">
      <div class="timeline-label-row">

        <!-- âœ… åªä¿ç•™å¹´ä»½ä¸‹æ‹‰ï¼ˆç§»é™¤å¹´ä»½æŒ‰éˆ•åˆ—ï¼‰ -->
        <select class="year-select" id="yearSelect" data-i18n-aria-label="aria.selectYear">
          <option value="" data-i18n="timeline.selectYear">Select year</option>
        </select>

        <button class="collapse-btn" id="timelineCollapseBtn" type="button" aria-expanded="true" data-i18n="timeline.collapse">Collapse timeline</button>
      </div>

      <!-- âœ… å…§å®¹å€åšæˆå¯æ»¾å‹•å®¹å™¨ï¼ˆæ‰‹æ©Ÿé¿å…é¢æ¿éé«˜æ’åˆ°åº•éƒ¨ï¼‰ -->
      <div class="timeline-scroll" id="timelineScroll">
        <div class="timeline" id="monthRow"></div>
        <div class="timeline" id="eventRow"></div>
      </div>
    </div>

    <div class="anchor-panel" id="anchorPanel" aria-live="polite">
      <div class="anchor-panel-header">
        <div>
          <p class="anchor-panel-title" data-i18n="anchor.title">One Step Blue Sky | Timeline</p>
          <p class="anchor-panel-sub" data-i18n="anchor.subtitle">Scan the QR code to open each timeline item with photos and posts. Scroll to explore.</p>
        </div>
        <button class="tiny-btn" id="anchorCloseBtn" type="button" data-i18n="anchor.close">âœ•</button>
      </div>
      <div class="anchor-list" id="anchorList"></div>
    </div>
  </div>

  <div class="qr-modal" id="qrModal" role="dialog" aria-modal="true" data-i18n-aria-label="aria.qrDialog">
    <div class="qr-card">
      <h3 id="qrTitle" style="margin-top:0;margin-bottom:6px;" data-i18n="qr.title">Timeline QR</h3>
      <div id="qrSubtitle" style="color:#a8b2d8;margin-bottom:10px;"></div>
      <img id="qrImage" src="" alt="QRcode for anchor link">
      <button class="tiny-btn" id="qrCloseBtn" type="button" data-i18n="qr.close">Close</button>
    </div>
  </div>

  <script>
    if (!window.THREE) {
      alert('THREE failed to load. Please confirm three.min.js can load and is not blocked.');
      throw new Error('THREE is undefined');
    }
    const THREE = window.THREE;

    const QUALITY = window.innerWidth < 768 ? 'mobile' : 'desktop';
    const IS_MOBILE = window.matchMedia('(max-width: 768px)').matches;
    const LANG_STORAGE_KEY = 'bsr_lang';

    const MONTHS_EN = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    const I18N = {
      en: {
        aria: {
          pjcSite: 'Visit the PJC website',
          about: 'About Blue Sky Returns',
          modeToggle: 'Toggle mode',
          languageToggle: 'Switch language',
          selectYear: 'Select year',
          qrDialog: 'Timeline QR code'
        },
        header: {
          about: 'About',
          timeline: 'ğŸ“Œ Timeline'
        },
        mode: {
          crisis: 'âš ï¸ CRISIS',
          hope: 'ğŸŒ HOPE'
        },
        labels: {
          crisis: 'CRISIS',
          hope: 'HOPE'
        },
        info: {
          collapse: 'Collapse info',
          expand: 'Expand info',
          loading: 'Loading...',
          subtitle: {
            disaster: 'Crisis event',
            solution: 'Hope action'
          }
        },
        timeline: {
          selectYear: 'Select year',
          collapse: 'Collapse timeline',
          expand: 'Expand timeline'
        },
        anchor: {
          title: 'One Step Blue Sky | Timeline',
          subtitle: 'Scan the QR code to open each timeline item with photos and posts. Scroll to explore.',
          close: 'âœ•',
          qr: 'QR code',
          locate: 'Locate',
          showMore: 'Show more',
          showLess: 'Show less'
        },
        qr: {
          title: 'Timeline QR',
          close: 'Close'
        },
        misc: {
          noMedia: 'No media available',
          fetchFail: 'Unable to load data file',
          initFail: 'Initialization failed'
        },
        page: {
          title: 'Blue Sky Returns'
        }
      },
      zh: {
        aria: {
          pjcSite: 'å‰å¾€ PJC ç¶²ç«™',
          about: 'é—œæ–¼ Blue Sky Returns',
          modeToggle: 'åˆ‡æ›æ¨¡å¼',
          languageToggle: 'åˆ‡æ›èªè¨€',
          selectYear: 'é¸æ“‡å¹´ä»½',
          qrDialog: 'æ™‚é–“ç·š QRcode'
        },
        header: {
          about: 'é—œæ–¼',
          timeline: 'ğŸ“Œ æ™‚é–“ç·š'
        },
        mode: {
          crisis: 'âš ï¸ å±æ©Ÿ',
          hope: 'ğŸŒ å¸Œæœ›'
        },
        labels: {
          crisis: 'å±æ©Ÿ',
          hope: 'å¸Œæœ›'
        },
        info: {
          collapse: 'æ”¶åˆè³‡è¨Š',
          expand: 'å±•é–‹è³‡è¨Š',
          loading: 'è¼‰å…¥ä¸­...',
          subtitle: {
            disaster: 'å±æ©Ÿäº‹ä»¶',
            solution: 'è§£æ–¹è¡Œå‹•'
          }
        },
        timeline: {
          selectYear: 'é¸æ“‡å¹´ä»½',
          collapse: 'æ”¶åˆæ™‚é–“è¡¨',
          expand: 'å±•é–‹æ™‚é–“è¡¨'
        },
        anchor: {
          title: 'ä¸€æ­¥ï¼è—å¤©ï½œæ™‚é–“ç·š',
          subtitle: 'æƒ QRcode å¯ç›´æ¥æ‰“é–‹æ™‚é–“é»ã€ç…§ç‰‡èˆ‡è²¼æ–‡é é¢ï¼Œæ»‘å‹•æŸ¥çœ‹',
          close: 'âœ•',
          qr: 'QRcode',
          locate: 'å®šä½',
          showMore: 'å±•é–‹æ›´å¤š',
          showLess: 'æ”¶åˆ'
        },
        qr: {
          title: 'æ™‚é–“é» QR',
          close: 'é—œé–‰'
        },
        misc: {
          noMedia: 'ç„¡åª’é«”è³‡æ–™',
          fetchFail: 'ç„¡æ³•è¼‰å…¥è³‡æ–™æª”æ¡ˆ',
          initFail: 'åˆå§‹åŒ–å¤±æ•—'
        },
        page: {
          title: 'ä¸€æ­¥ãƒ»è—å¤© BLUE SKY RETURNS'
        }
      }
    };

    const STAT_LABELS_EN = {
      'é™é›¨é‡': 'Rainfall',
      'æŒçºŒæ™‚é–“': 'Duration',
      'ç‡ƒç‡’é¢ç©': 'Burned area',
      'å½±éŸ¿åŸå¸‚': 'Affected cities',
      'é¢ç©': 'Area',
      'è¼ƒ 1981-2010': 'vs 1981â€“2010',
      'æœ€é«˜æ°£æº«': 'Peak temperature',
      'ä¼°è¨ˆæ­»äº¡äººæ•¸': 'Estimated deaths',
      'å—å½±éŸ¿äººå£': 'Affected population',
      'æ·¹æ°´é¢ç©': 'Flooded area',
      'åœ°è¡¨æº«åº¦': 'Surface temperature',
      'æ’¤é›¢äººæ•¸': 'Evacuations',
      'æœ€å¤§é¢¨é€Ÿ': 'Max wind speed',
      'æœ€é«˜é›¨é‡': 'Peak rainfall',
      'ç¨®æ¤æ¨¹æœ¨': 'Trees planted',
      'åƒèˆ‡äººæ•¸': 'Participants',
      'è£ç½®å®¹é‡': 'Installed capacity',
      'å¯ä¾›å®¶åº­': 'Homes powered',
      'é‡ç½å€': 'Hardest-hit areas',
      'è¡æ“Š': 'Impact',
      'é—œæ³¨ç„¦é»': 'Focus',
      'é€£å‹•': 'Linkages',
      'ç‰¹å¾µ': 'Key trait',
      'é¢¨éšª': 'Risk',
      'å½±éŸ¿': 'Impact',
      'å‹æ…‹': 'Pattern',
      'åœ°å½¢': 'Terrain',
      'ç„¦é»': 'Focus',
      'æ‡‰å°': 'Response',
      'åŠŸèƒ½': 'Function',
      'æ•ˆç›Š': 'Benefit',
      'æªæ–½': 'Measures',
      'é ä¼°ç¯€é›»': 'Estimated savings',
      'æ¨¡å¼': 'Model',
      'å—ç›Š': 'Benefit',
      'å›æ”¶é‡': 'Recovered volume',
      'å†ç”Ÿç”¨é€”': 'Reuse outputs',
      'è¦†è“‹': 'Coverage',
      'ç›®æ¨™': 'Goal',
      'å½¢å¼': 'Format',
      'ç›®çš„': 'Purpose'
    };

    const STAT_VALUES_EN = {
      'ä¸‰åˆ†ä¹‹ä¸€åœ‹åœŸ': 'One-third of the country',
      'æ²¿å²¸åŸå¸‚': 'Coastal cities',
      'äº¤é€š / ä¾›é›»': 'Transport / power',
      'ç…™éœ¾ / æ£®æ—é€€åŒ–': 'Haze / forest degradation',
      'ä¹¾å­£å»¶é•·': 'Longer dry season',
      'æ¥µç«¯æº«åº¦å³°å€¼': 'Extreme temperature spike',
      'èå†°åŠ é€Ÿ': 'Accelerated ice melt',
      'ç©ºå“æƒ¡åŒ–': 'Air quality decline',
      'é«˜æº« / ä¹¾æ—±': 'Heat / drought',
      'çŸ­å»¶æ™‚å¼·é™é›¨': 'Short-duration intense rainfall',
      'æ²³å·æš´æ¼²': 'Rapid river rise',
      'å¡åœ° / æ²³è°·': 'Slopes / valleys',
      'è½çŸ³ / å´©å¡Œ': 'Rockfall / landslide',
      'é›»ç¶² / å¥åº·': 'Grid / health',
      'æå‰åˆ°ä¾†': 'Earlier onset',
      'å¤šå­£é™é›¨ä¸è¶³': 'Multi-season rainfall deficit',
      'ç³§é£Ÿ / ç‰§å ´': 'Food / pasture',
      'çŠç‘š / æ¼æ¥­': 'Coral / fisheries',
      'æŒçºŒåæš–': 'Persistently warm',
      'æ’æ°´ / åœ°å‹¢': 'Drainage / terrain',
      'æ»¯æ´ª / æµ·ç¶¿åŸå¸‚': 'Retention / sponge city',
      'å­£ç¯€åç§»': 'Seasonal shift',
      'ç—…åª’ / ç”Ÿæ…‹': 'Vectors / ecology',
      'é‹’é¢æ»¯ç•™': 'Stalled front',
      'æ·¹æ°´ / äº¤é€š': 'Flooding / transport',
      'çŸ­æ™‚é›¨å¼·å¤§': 'Intense short-duration rain',
      'æ¨¹å€’ / ç©æ°´': 'Fallen trees / pooling',
      'èª¿è“„ / é™æº«': 'Retention / cooling',
      'é™ä½å…§æ¾‡é¢¨éšª': 'Lower pluvial flood risk',
      'LED / æ™ºæ…§ç©ºèª¿': 'LED / smart HVAC',
      'å…±äº« / è™›æ“¬é›»å» ': 'Sharing / virtual power plant',
      'ç”¨é›»æˆæœ¬ä¸‹é™': 'Lower electricity costs',
      'æ¯æœˆ 12tï¼ˆç¤ºä¾‹ï¼‰': '12t per month (example)',
      'å»ºæ / ç¹”å“': 'Construction / textiles',
      'å¤šèªé€šçŸ¥': 'Multilingual alerts',
      'ç¸®çŸ­æ‡‰è®Šæ™‚é–“': 'Shorter response time',
      'å–®è»Š / åœ°æ¿': 'Bikes / floors',
      'æ•™è‚² / åƒèˆ‡': 'Education / participation'
    };

    const EVENT_TRANSLATIONS_EN = {
      evt_001: {
        title: 'Dubai Extreme Rainfall',
        description: 'A desert city faced unprecedented rainfall, putting urban drainage systems under massive strain.'
      },
      evt_002: {
        title: 'Australia Black Summer Bushfires',
        description: 'Heat and drought-driven fires blanketed major cities in smoke and affected millions.'
      },
      evt_003: {
        title: 'Arctic Sea Ice Hits New Low',
        description: 'Satellite data showed sea ice area at a record low, reflecting high-latitude warming trends.'
      },
      evt_004: {
        title: 'Western Canada Heat Dome',
        description: 'A heat dome pushed temperatures to record highs, triggering health crises and infrastructure failures.'
      },
      evt_005: {
        title: 'Pakistan Monsoon Floods',
        description: 'Exceptionally strong monsoons and glacial melt caused widespread flooding, damaging infrastructure and agriculture.'
      },
      evt_006: {
        title: 'Southern Europe Heatwave & Wildfires',
        description: 'Sustained heat and drought sparked wildfires across Mediterranean countries, impacting air quality and tourism.'
      },
      evt_007: {
        title: 'Super Typhoon Saola Strikes South China Again',
        description: 'Record winds and rain battered the Pearl River Delta and Hong Kongâ€“Macau, testing flood protection and transport.'
      },
      sol_001: {
        title: 'Amazon Rainforest Restoration Hub',
        description: 'A reforestation program with Indigenous partners to boost biodiversity and carbon sequestration.'
      },
      sol_002: {
        title: 'Taiwan Offshore Wind Farm',
        description: 'New offshore turbines came online, delivering stable green power to support energy transition.'
      },
      evt_008: {
        title: 'Cyclone Idai in Mozambique (Coastal Flooding)',
        description: 'A tropical cyclone brought heavy rain and storm surge, flooding coastal areas and disrupting infrastructure.'
      },
      evt_009: {
        title: 'Amazon Rainforest Fires (Smoke Haze Spread)',
        description: 'Fires and land clearing spread haze, highlighting the combined risks of land use and climate conditions.'
      },
      evt_010: {
        title: 'Antarctic Temperature Anomaly (Short-Term Extreme)',
        description: 'A short-lived temperature spike became a signal of extreme warming conditions.'
      },
      evt_011: {
        title: 'US West Coast Fire Season (Smoke Coverage)',
        description: 'Fire season combined with heat and drought, degrading air quality and visibility and impacting health.'
      },
      evt_012: {
        title: 'Western Europe Floods',
        description: 'Extreme rain rapidly swelled rivers and flooded towns, underscoring risk governance and early warning.'
      },
      evt_013: {
        title: 'Extreme Rainfall Triggers Landslides (Example)',
        description: 'Continuous rain saturated slopes, increasing landslide and rockfall risks and affecting transport and settlements.'
      },
      evt_014: {
        title: 'Indiaâ€“Pakistan Early Spring Heatwave (Example)',
        description: 'An early, prolonged heatwave strained power demand, outdoor labor, and public health.'
      },
      evt_015: {
        title: 'Horn of Africa Prolonged Drought (Example)',
        description: 'Multi-season rainfall deficits intensified water and food insecurity, hurting pastoral livelihoods.'
      },
      evt_016: {
        title: 'Marine Heatwave Expansion (Example)',
        description: 'Persistently warm sea surface temperatures stressed corals and marine ecosystems.'
      },
      evt_017: {
        title: 'Frequent Urban Flooding (Example)',
        description: 'Short, intense rainfall over dense urban areas raised pluvial flood risk, testing drainage and retention systems.'
      },
      evt_018: {
        title: 'Unseasonal Winter Warmth (Example)',
        description: 'Warmer winters disrupted ecosystems and disease vectors, affecting energy demand and public health.'
      },
      evt_019: {
        title: 'East Asian Mei-Yu Front Extreme Rainfall (Example)',
        description: 'A stalled frontal system brought continuous heavy rain, stressing transport and drainage with low-lying inundation.'
      },
      evt_020: {
        title: 'Late Autumn Downpours & Severe Convection (Example)',
        description: 'Out-of-season severe storms and intense rain elevated urban damage and transport delays.'
      },
      sol_003: {
        title: 'Urban Detention Park (Sponge City Example)',
        description: 'Detention parks and permeable paving increase stormwater storage while cooling cities and providing public space.'
      },
      sol_004: {
        title: 'Campus Energy Retrofit (Example)',
        description: 'Lighting and HVAC upgrades cut peak demand, with dashboards enabling campus participation.'
      },
      sol_005: {
        title: 'Community Solar Sharing (Example)',
        description: 'Shared solar and bill credits let residents benefit and join the energy transition.'
      },
      sol_006: {
        title: 'Plastic Recycling Circular Chain (Example)',
        description: 'Local sortingâ€“washingâ€“reprocessing improves purity and usability of recycled materials.'
      },
      sol_007: {
        title: 'Community Disaster Drills & Alert System (Example)',
        description: 'Integrates alerts, evacuation routes, and drills to boost resilience during extreme weather.'
      },
      sol_008: {
        title: 'Kinetic Power Experience Station (Example: Bikes/Floors)',
        description: 'Interactive kinetic power demos turn action â†’ electricity â†’ carbon reduction into public education.'
      }
    };

    const ANCHORS = {
      en: [
        {
          id: 'anchor-2024-observation',
          title: '2024 | Monitoring & Documentation',
          meta: 'Single-event focus with data and impact tracking',
          points: [
            'Launch One Step Blue Sky with a focus on individual extreme weather events',
            'Build climate observation records through data, visuals, and impacts',
            'Document each case as a public-facing climate log'
          ],
          igPosts: [
            'https://www.instagram.com/p/C-C2Ao8vq8P/',
            'https://www.instagram.com/p/C9wIiMIhwY-/',
            'https://www.instagram.com/p/C9ZiOZ-NNR2/',
            'https://www.instagram.com/p/C8_yyagv87R/',
            'https://www.instagram.com/p/C8WlkFMB--7/',
            'https://www.instagram.com/p/C7JF2sOPAnv/',
            'https://www.instagram.com/p/C63WPmMPh6O/',
            'https://www.instagram.com/p/C6BQzMdtcVW/'
          ]
        },
        {
          id: 'anchor-2024-awareness',
          title: '2024 | Public Awareness & Engagement',
          meta: 'Connect climate trends with daily life in Hong Kong',
          points: [
            'Publish climate logs and cultural media to spark everyday connections',
            'Link global climate signals to local routines and public warnings',
            'Invite reflection on how extreme weather shapes daily life'
          ],
          igPosts: [
            'https://www.instagram.com/p/C7REEP3vwe-/',
            'https://www.instagram.com/p/C6nVBzQvsLm/',
            'https://www.instagram.com/p/C6OHdsfvejs/',
            'https://www.instagram.com/p/C6I91dUBsF9/',
            'https://www.instagram.com/p/C5k6sjUPWZr/',
            'https://www.instagram.com/p/C5TMOz-PwnH/',
            'https://www.instagram.com/p/C5A2sRrvLTC/'
          ]
        },
        {
          id: 'anchor-2025-review',
          title: '2025 | Annual Review Release',
          meta: 'Release of the 2024 extreme weather report',
          points: [
            'Systematically review 2024 climate data for an annual report',
            'Publish the official 2024 extreme weather review',
            'Keep related 2025 series posts in the extended archive'
          ],
          igPosts: [
            'https://www.instagram.com/p/DFmNIOwPthe/'
          ]
        },
        {
          id: 'anchor-2025-exhibition',
          title: '2025 | Exhibition & Community Education',
          meta: 'On-site exhibition and education initiatives',
          points: [
            'Translate climate data into actionable knowledge through exhibitions',
            'Support community learning with visual stories and education programs',
            'Highlight climate solutions alongside documentation outcomes'
          ],
          igPosts: [
            'https://www.instagram.com/p/DL9qBMOPf1L/',
            'https://www.instagram.com/p/DLznY8lPiTu/',
            'https://www.instagram.com/p/DLeHQbFvCbg/',
            'https://www.instagram.com/p/DJ6cm_jqvgd/',
            'https://www.instagram.com/p/DIwC9DSPqs2/'
          ]
        },
        {
          id: 'anchor-2025-international',
          title: '2025 | International Exchange & Closure',
          meta: 'UN exchange and youth collaboration outcomes',
          points: [
            'Facilitate international dialogue and climate policy simulations',
            'Showcase youth collaboration across regions and institutions',
            'Conclude the phase with shared insights and collective outcomes'
          ],
          igPosts: [
            'https://www.instagram.com/p/DNkpy4BPspK/',
            'https://www.instagram.com/p/DNu-Al5XijM/',
            'https://www.instagram.com/p/DNM1eG1Tpfa/',
            'https://www.instagram.com/p/DHasIQjvYHk/',
            'https://www.instagram.com/p/DGM3X2fPwvE/'
          ]
        },
        {
          id: 'anchor-2026-energy',
          title: '2026 | Transforming into Energy',
          meta: 'Kinetic energy to clean power',
          points: [
            'Combine sports and green technology to generate clean electricity',
            'Turn human kinetic energy into tangible low-carbon action',
            'Prepare for upcoming demonstrations and installations'
          ],
          igPosts: []
        }
      ],
      zh: [
        {
          id: 'anchor-2024-observation',
          title: '2024ï½œè§€å¯Ÿèˆ‡è¨˜éŒ„ Monitoring & Documentation',
          meta: 'èšç„¦å–®ä¸€äº‹ä»¶ï¼Œä»¥æ•¸æ“šèˆ‡å½±éŸ¿å»ºç«‹è§€å¯Ÿæª”æ¡ˆ',
          points: [
            'å•Ÿå‹•ã€Œä¸€æ­¥ï¼è—å¤©ã€è¨ˆç•«ï¼Œèšç„¦å€‹åˆ¥æ¥µç«¯æ°£å€™äº‹ä»¶',
            'ä»¥æ•¸æ“šã€å½±åƒèˆ‡å½±éŸ¿å»ºç«‹æ°£å€™è§€å¯Ÿæª”æ¡ˆ',
            'æŠŠæ¯å€‹äº‹ä»¶æ•´ç†æˆå¯å…¬é–‹åˆ†äº«çš„æ°£å€™å¤©æ°£ç°¿'
          ],
          igPosts: [
            'https://www.instagram.com/p/C-C2Ao8vq8P/',
            'https://www.instagram.com/p/C9wIiMIhwY-/',
            'https://www.instagram.com/p/C9ZiOZ-NNR2/',
            'https://www.instagram.com/p/C8_yyagv87R/',
            'https://www.instagram.com/p/C8WlkFMB--7/',
            'https://www.instagram.com/p/C7JF2sOPAnv/',
            'https://www.instagram.com/p/C63WPmMPh6O/',
            'https://www.instagram.com/p/C6BQzMdtcVW/'
          ]
        },
        {
          id: 'anchor-2024-awareness',
          title: '2024ï½œè­°é¡Œé€£çµæ—¥å¸¸ Public Awareness & Engagement',
          meta: 'æŠŠå…¨çƒæ°£å€™è®ŠåŒ–é€£çµè‡³é¦™æ¸¯æ—¥å¸¸ç”Ÿæ´»',
          points: [
            'é€éæ°£å€™å¤©æ°£ç°¿èˆ‡æ–‡åŒ–åª’ä»‹æ¨é€²å…¬çœ¾åƒèˆ‡',
            'å°‡å…¨çƒæ¥µç«¯è¶¨å‹¢é€£çµè‡³æœ¬åœ°æ—¥å¸¸èˆ‡å…¬å…±è­¦å ±',
            'å¼•å°å…¬çœ¾æ€è€ƒæ¥µç«¯æ°£å€™å°æ—¥å¸¸çš„å½±éŸ¿'
          ],
          igPosts: [
            'https://www.instagram.com/p/C7REEP3vwe-/',
            'https://www.instagram.com/p/C6nVBzQvsLm/',
            'https://www.instagram.com/p/C6OHdsfvejs/',
            'https://www.instagram.com/p/C6I91dUBsF9/',
            'https://www.instagram.com/p/C5k6sjUPWZr/',
            'https://www.instagram.com/p/C5TMOz-PwnH/',
            'https://www.instagram.com/p/C5A2sRrvLTC/'
          ]
        },
        {
          id: 'anchor-2025-review',
          title: '2025ï½œå¹´åº¦å›é¡§ç™¼å¸ƒ Annual Review Release',
          meta: 'ç™¼å¸ƒã€Š2024 å¹´åº¦æ¥µç«¯æ°£å€™å›é¡§ã€‹',
          points: [
            'ç³»çµ±æ€§æ•´ç† 2024 å…¨å¹´è³‡æ–™ä¸¦å®Œæˆå ±å‘Š',
            'æ­£å¼ç™¼å¸ƒã€Š2024 å¹´åº¦æ¥µç«¯æ°£å€™å›é¡§ã€‹',
            'å…¶é¤˜ 2025 ç³»åˆ—è²¼æ–‡å¯ç½®æ–¼è³‡æ–™åº«å»¶ä¼¸é–±è®€'
          ],
          igPosts: [
            'https://www.instagram.com/p/DFmNIOwPthe/'
          ]
        },
        {
          id: 'anchor-2025-exhibition',
          title: '2025ï½œå¯¦é«”å±•è¦½èˆ‡ç¤¾å€æ•™è‚² Exhibition & Community Education',
          meta: 'ä»¥å±•è¦½èˆ‡æ•™è‚²æŠŠæ•¸æ“šè½‰åŒ–ç‚ºå¯è¡Œå‹•çš„çŸ¥è­˜',
          points: [
            'é€éå¯¦é«”å±•è¦½å‘ˆç¾æ°£å€™æ•¸æ“šèˆ‡æ¡ˆä¾‹',
            'ä»¥ç¤¾å€æ•™è‚²æ¨å‹•å¯è¡Œå‹•çš„æ°£å€™çŸ¥è­˜',
            'å¼·èª¿è³‡æ–™è¦–è¦ºåŒ–èˆ‡ç”Ÿæ´»æ‡‰ç”¨'
          ],
          igPosts: [
            'https://www.instagram.com/p/DL9qBMOPf1L/',
            'https://www.instagram.com/p/DLznY8lPiTu/',
            'https://www.instagram.com/p/DLeHQbFvCbg/',
            'https://www.instagram.com/p/DJ6cm_jqvgd/',
            'https://www.instagram.com/p/DIwC9DSPqs2/'
          ]
        },
        {
          id: 'anchor-2025-international',
          title: '2025ï½œåœ‹éš›äº¤æµèˆ‡ç¸½çµ International Exchange & Closure',
          meta: 'åœ‹éš›äº¤æµèˆ‡æ°£å€™æ”¿ç­–æ¨¡æ“¬',
          points: [
            'æ–¼è¯åˆåœ‹å ´åŸŸé€²è¡Œåœ‹éš›äº¤æµèˆ‡æ”¿ç­–æ¨¡æ“¬',
            'å±•ç¾é’å¹´è·¨åœ°åŸŸåˆä½œèˆ‡æˆæœ',
            'æ•´ç†äº¤æµæˆæœä½œç‚ºéšæ®µæ€§ç¸½çµ'
          ],
          igPosts: [
            'https://www.instagram.com/p/DNkpy4BPspK/',
            'https://www.instagram.com/p/DNu-Al5XijM/',
            'https://www.instagram.com/p/DNM1eG1Tpfa/',
            'https://www.instagram.com/p/DHasIQjvYHk/',
            'https://www.instagram.com/p/DGM3X2fPwvE/'
          ]
        },
        {
          id: 'anchor-2026-energy',
          title: '2026ï½œè½‰åŒ–ç‚ºèƒ½ Transforming into Energy',
          meta: 'ä»¥å‹•èƒ½è½‰åŒ–ç‚ºæ¸…æ½”é›»åŠ›',
          points: [
            'çµåˆé‹å‹•èˆ‡ç¶ èƒ½ç§‘æŠ€æŠŠå‹•èƒ½è½‰ç‚ºé›»åŠ›',
            'å¯¦è¸é›¶ç¢³è¡Œå‹•èˆ‡å¯è¦–åŒ–æ•™è‚²',
            'ä½œç‚ºä¸‹ä¸€éšæ®µå³å°‡å±•é–‹çš„é …ç›®'
          ],
          igPosts: []
        }
      ]
    };

    const lerp = (a, b, t) => a + (b - a) * t;
    const clamp01 = (x) => Math.max(0, Math.min(1, x));

    const playEntryOverlay = () => {
      const overlay = document.getElementById('entryOverlay');
      if (!overlay) return;

      requestAnimationFrame(() => {
        overlay.classList.add('show');
        setTimeout(() => {
          overlay.classList.add('fade-out');
          overlay.addEventListener('transitionend', () => overlay.remove(), { once: true });
          setTimeout(() => overlay.remove(), 2200);
        }, 1200);
      });
    };

    const ASSET_BASE = './assets/';
    const TEXTURE = {
      day: `${ASSET_BASE}earth_day.jpg`,
      bump: `${ASSET_BASE}earth_bump.jpg`,
      specular: `${ASSET_BASE}earth_specular.jpg`
    };

    const COLORS = { crisis: '#FF4D4D', hope: '#00D2FF', hopeAlt: '#2ECC40' };

    const state = {
      events: [],
      filtered: [],
      currentMode: 'crisis',
      world: null,
      initialView: { lat: 23.5, lng: 121.0, altitude: 2.5 },
      currentYear: null,
      currentMonth: null,
      currentEventId: null,
      infoCollapsed: false,
      timelineCollapsed: false,
      anchorOpen: false,
      language: 'en'
    };

    const getI18n = (path) => {
      const keys = path.split('.');
      let value = I18N[state.language] ?? I18N.en;
      for (const key of keys) {
        if (value && typeof value === 'object' && key in value) {
          value = value[key];
        } else {
          return '';
        }
      }
      return value;
    };

    const getEventTranslation = (event) => {
      if (state.language !== 'en') return event;
      const translated = EVENT_TRANSLATIONS_EN[event.id];
      if (!translated) return event;
      return {
        ...event,
        title: translated.title ?? event.title,
        description: translated.description ?? event.description
      };
    };

    const translateStatLabel = (label) => (
      state.language === 'en' ? (STAT_LABELS_EN[label] ?? label) : label
    );

    const translateStatValue = (value) => (
      state.language === 'en' ? (STAT_VALUES_EN[value] ?? value) : value
    );

    const getMonthLabel = (month) => (
      state.language === 'en' ? (MONTHS_EN[month - 1] ?? month) : `${month}æœˆ`
    );

    const applyTranslations = () => {
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.dataset.i18n;
        const text = getI18n(key);
        if (text) el.textContent = text;
      });

      document.querySelectorAll('[data-i18n-aria-label]').forEach(el => {
        const key = el.dataset.i18nAriaLabel;
        const text = getI18n(key);
        if (text) el.setAttribute('aria-label', text);
      });

      document.querySelectorAll('[data-i18n-title]').forEach(el => {
        const key = el.dataset.i18nTitle;
        const text = getI18n(key);
        if (text) el.setAttribute('title', text);
      });

      document.documentElement.lang = state.language === 'en' ? 'en' : 'zh-Hant';
    };

    const applyLanguage = (lang) => {
      state.language = lang === 'zh' ? 'zh' : 'en';
      localStorage.setItem(LANG_STORAGE_KEY, state.language);
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === state.language);
      });
      applyTranslations();
      document.title = getI18n('page.title') || document.title;
      buildAnchorList();
      refreshFiltersUI();
      setInfoCollapsed(state.infoCollapsed);
      setTimelineCollapsed(state.timelineCollapsed);
      if (state.world) {
        renderPoints();
        if (state.currentEventId) {
          const current = state.events.find(ev => ev.id === state.currentEventId);
          if (current) showInfo(current);
        }
      }
      updateYearSelect(getYears());
    };

    const fetchJSON = async (path) => {
      const res = await fetch(path, { cache: 'no-store' });
      if (!res.ok) throw new Error(`${getI18n('misc.fetchFail')}: ${path} (${res.status})`);
      return res.json();
    };

    const preloadImage = (url) => new Promise((resolve, reject) => {
      const img = new Image();
      img.onload = () => resolve(url);
      img.onerror = () => reject(new Error('Image failed to load: ' + url));
      img.src = url;
    });

    // ===== è³‡æ–™å·¥å…·ï¼ˆyear/month ä»¥ date æ¨å°ï¼‰
    const getYears = () =>
      Array.from(new Set(state.filtered.map(e => e.year))).sort((a,b)=>a-b);

    const getMonthsByYear = (year) =>
      Array.from(new Set(state.filtered.filter(e => e.year === year).map(e => e.month)))
        .sort((a,b)=>a-b);

    const getEventsByYearMonth = (year, month) =>
      state.filtered
        .filter(e => e.year === year && e.month === month)
        .sort((a,b)=> (a.date || '').localeCompare(b.date || ''));

    const updateYearSelect = (years) => {
      const select = document.getElementById('yearSelect');
      select.innerHTML = '';
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = getI18n('timeline.selectYear');
      select.appendChild(placeholder);
      years.forEach(year => {
        const opt = document.createElement('option');
        opt.value = year;
        opt.textContent = year;
        select.appendChild(opt);
      });
      select.disabled = years.length === 0;
      if (state.currentYear != null) select.value = String(state.currentYear);
    };

    const highlightMonth = (month) => {
      document.querySelectorAll('#monthRow .pill-btn').forEach(btn => {
        btn.classList.toggle('active', Number(btn.dataset.month) === Number(month));
        btn.dataset.mode = state.currentMode;
      });
    };

    const highlightEvent = (eventId) => {
      document.querySelectorAll('#eventRow .pill-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.eventId === String(eventId));
        btn.dataset.mode = state.currentMode;
      });
    };

    const renderMonths = (year) => {
      const row = document.getElementById('monthRow');
      row.innerHTML = '';
      const months = getMonthsByYear(year);

      months.forEach(m => {
        const btn = document.createElement('button');
        btn.className = 'pill-btn';
        btn.textContent = getMonthLabel(m);
        btn.dataset.month = m;
        btn.dataset.mode = state.currentMode;
        btn.classList.toggle('active', Number(m) === Number(state.currentMonth));
        btn.addEventListener('click', () => jumpToMonth(year, m));
        row.appendChild(btn);
      });

      if (months.length === 0) document.getElementById('eventRow').innerHTML = '';
    };

    const renderEvents = (year, month) => {
      const row = document.getElementById('eventRow');
      row.innerHTML = '';
      const items = getEventsByYearMonth(year, month);

      items.forEach((ev) => {
        const translated = getEventTranslation(ev);
        const btn = document.createElement('button');
        btn.className = 'pill-btn';
        btn.style.minWidth = '160px';
        btn.textContent = translated.title;
        btn.dataset.eventId = ev.id;
        btn.dataset.mode = state.currentMode;
        btn.classList.toggle('active', ev.id === state.currentEventId);
        btn.addEventListener('click', () => {
          state.currentEventId = ev.id;
          showInfo(ev);
          highlightEvent(ev.id);
        });
        row.appendChild(btn);
      });
    };

    const renderPoints = () => {
      state.filtered = state.events.filter(ev => ev.mode === state.currentMode);
      state.world.pointsData(state.filtered);
    };

    const refreshFiltersUI = () => {
      const years = getYears();
      updateYearSelect(years);

      const y = state.currentYear ?? years[0];
      if (!y) return;

      state.currentYear = Number(y);
      document.getElementById('yearSelect').value = String(state.currentYear);

      const months = getMonthsByYear(state.currentYear);
      state.currentMonth = (state.currentMonth && months.includes(state.currentMonth))
        ? state.currentMonth
        : (months[0] ?? null);

      renderMonths(state.currentYear);
      highlightMonth(state.currentMonth);

      if (state.currentMonth != null) {
        renderEvents(state.currentYear, state.currentMonth);
        const first = getEventsByYearMonth(state.currentYear, state.currentMonth)[0];
        if (first) {
          state.currentEventId = first.id;
          highlightEvent(first.id);
        }
      } else {
        document.getElementById('eventRow').innerHTML = '';
      }
    };

    const buildPointObject = (d) => {
      const color = d.mode === 'crisis' ? COLORS.crisis : COLORS.hope;
      const glow = new THREE.Mesh(
        new THREE.SphereGeometry(0.6, 16, 16),
        new THREE.MeshBasicMaterial({ color, transparent: true, opacity: 0.25 })
      );
      const core = new THREE.Mesh(
        new THREE.SphereGeometry(0.28, 12, 12),
        new THREE.MeshBasicMaterial({ color, transparent: true, opacity: 0.9 })
      );
      glow.add(core);
      return glow;
    };

    const createPulse = () => {
      const loop = () => {
        const t = Date.now() * 0.004;
        state.filtered.forEach(d => {
          const obj = d.__threeObj;
          if (!obj) return;
          const scale = 0.85 + 0.25 * Math.sin(t + d.lat);
          obj.scale.setScalar(scale);
          const mat = obj.children?.[0]?.material || obj.material;
          if (mat) mat.opacity = 0.8 + 0.2 * Math.sin(t + d.lng);
        });
        requestAnimationFrame(loop);
      };
      loop();
    };

    const animateMaterialTint = (mode) => {
      const mat = state.world?.globeMaterial?.();
      if (!mat) return;

      if (!mat.color || typeof mat.color.setRGB !== 'function') mat.color = new THREE.Color('#ffffff');
      if (!mat.emissive || typeof mat.emissive.setRGB !== 'function') mat.emissive = new THREE.Color('#000000');

      const target = (mode === 'crisis')
        ? { c: { r: 1.05, g: 0.90, b: 0.90 }, e: { r: 0.10, g: 0.03, b: 0.03 } }
        : { c: { r: 0.92, g: 1.02, b: 1.05 }, e: { r: 0.02, g: 0.08, b: 0.10 } };

      const start = {
        c: { r: mat.color.r, g: mat.color.g, b: mat.color.b },
        e: { r: mat.emissive.r, g: mat.emissive.g, b: mat.emissive.b }
      };

      const duration = 450;
      const t0 = performance.now();

      const step = (now) => {
        const t = clamp01((now - t0) / duration);
        const ease = t * (2 - t);

        mat.color.setRGB(
          lerp(start.c.r, target.c.r, ease),
          lerp(start.c.g, target.c.g, ease),
          lerp(start.c.b, target.c.b, ease)
        );
        mat.emissive.setRGB(
          lerp(start.e.r, target.e.r, ease),
          lerp(start.e.g, target.e.g, ease),
          lerp(start.e.b, target.e.b, ease)
        );

        if (t < 1) requestAnimationFrame(step);
      };
      requestAnimationFrame(step);
    };

    const applyMode = (mode) => {
      state.currentMode = mode;
      document.body.dataset.mode = mode;
      document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
      });

      animateMaterialTint(mode);
      renderPoints();

      // mode åˆ‡æ›å¾Œï¼šé‡å»ºä¸‹æ‹‰/æœˆä»½/äº‹ä»¶
      state.currentYear = null;
      state.currentMonth = null;
      state.currentEventId = null;

      refreshFiltersUI();

      // è‡ªå‹•é¡¯ç¤ºç¬¬ä¸€å€‹äº‹ä»¶
      const first = state.filtered[0];
      if (first) {
        state.currentYear = first.year;
        state.currentMonth = first.month;
        state.currentEventId = first.id;
        refreshFiltersUI();
        showInfo(first);
      } else {
        document.getElementById('infoPanel').classList.remove('show');
      }
    };

    const showInfo = (data) => {
      if (!data) return;

      // âœ… æ‰‹æ©Ÿï¼šé»äº‹ä»¶å°±æ”¶åˆæ™‚é–“è¡¨ï¼ˆé¿å…å¹²æ“¾/é‡ç–Šï¼‰
      if (IS_MOBILE) setTimelineCollapsed(true);

      state.world.pointOfView({ lat: data.lat, lng: data.lng, altitude: 1.8 }, 1200);

      const translated = getEventTranslation(data);
      const card = document.getElementById('infoPanel');
      const tag = document.getElementById('infoTag');
      tag.className = `tag ${data.mode}`;
      tag.textContent = data.mode === 'crisis' ? getI18n('labels.crisis') : getI18n('labels.hope');

      document.getElementById('infoTitle').textContent = `${data.year} Â· ${translated.title}`;
      document.getElementById('infoSubtitle').textContent = data.category === 'disaster'
        ? getI18n('info.subtitle.disaster')
        : getI18n('info.subtitle.solution');
      document.getElementById('infoDesc').textContent = translated.description || '';
      document.getElementById('infoDate').textContent = data.date || '--';

      const statList = document.getElementById('statList');
      statList.innerHTML = '';
      (data.stats || []).forEach(item => {
        const block = document.createElement('div');
        block.className = 'stat-pill';
        const label = translateStatLabel(item.label);
        const value = translateStatValue(item.value);
        block.innerHTML = `<div class="stat-label">${label}</div><div><strong>${value}</strong></div>`;
        statList.appendChild(block);
      });

      const mediaContainer = document.getElementById('mediaContainer');
      mediaContainer.innerHTML = '';
      if (data.media?.type === 'instagram' && data.media.url) {
        const blockquote = document.createElement('blockquote');
        blockquote.className = 'instagram-media';
        blockquote.setAttribute('data-instgrm-permalink', data.media.url);
        blockquote.setAttribute('data-instgrm-version', '14');
        blockquote.style.margin = '0 auto';
        mediaContainer.appendChild(blockquote);
        setTimeout(() => window.instgrm?.Embeds?.process?.(), 120);
      } else if (data.media?.type === 'image' && data.media.url) {
        const img = document.createElement('img');
        img.src = data.media.url;
        img.alt = data.title || 'image';
        mediaContainer.appendChild(img);
      } else {
        mediaContainer.innerHTML = `<div style="padding:16px;opacity:0.7;">${getI18n('misc.noMedia')}</div>`;
      }

      card.classList.add('show');
    };

    const jumpToYear = (year) => {
      state.currentYear = Number(year);

      const months = getMonthsByYear(state.currentYear);
      state.currentMonth = months[0] ?? null;
      state.currentEventId = null;

      renderMonths(state.currentYear);
      highlightMonth(state.currentMonth);

      if (state.currentMonth != null) {
        renderEvents(state.currentYear, state.currentMonth);
        const first = getEventsByYearMonth(state.currentYear, state.currentMonth)[0];
        if (first) {
          state.currentEventId = first.id;
          highlightEvent(first.id);
          showInfo(first);
        }
      } else {
        document.getElementById('infoPanel').classList.remove('show');
        document.getElementById('eventRow').innerHTML = '';
      }
    };

    const jumpToMonth = (year, month) => {
      state.currentYear = Number(year);
      state.currentMonth = Number(month);
      state.currentEventId = null;

      document.getElementById('yearSelect').value = String(state.currentYear);

      renderMonths(state.currentYear);
      highlightMonth(state.currentMonth);

      renderEvents(state.currentYear, state.currentMonth);

      const first = getEventsByYearMonth(state.currentYear, state.currentMonth)[0];
      if (first) {
        state.currentEventId = first.id;
        highlightEvent(first.id);
        showInfo(first);
      }
    };

    const setInfoCollapsed = (collapsed) => {
      state.infoCollapsed = collapsed;
      const panel = document.getElementById('infoPanel');
      panel.classList.toggle('collapsed', collapsed);
      document.getElementById('infoCollapseBtn').textContent = collapsed
        ? getI18n('info.expand')
        : getI18n('info.collapse');
      document.getElementById('infoCollapseBtn').setAttribute('aria-expanded', String(!collapsed));
      document.getElementById('infoBody').setAttribute('aria-hidden', String(collapsed));
    };

    const setTimelineCollapsed = (collapsed) => {
      state.timelineCollapsed = collapsed;
      const container = document.getElementById('timelineContainer');
      container.classList.toggle('collapsed', collapsed);
      document.getElementById('timelineCollapseBtn').textContent = collapsed
        ? getI18n('timeline.expand')
        : getI18n('timeline.collapse');
      document.getElementById('timelineCollapseBtn').setAttribute('aria-expanded', String(!collapsed));
    };

    const openAnchorPanel = () => {
      state.anchorOpen = true;
      document.getElementById('anchorPanel').classList.add('show');
    };

    const closeAnchorPanel = () => {
      state.anchorOpen = false;
      document.getElementById('anchorPanel').classList.remove('show');
    };

    const toggleAnchorPanel = () => {
      if (state.anchorOpen) closeAnchorPanel(); else openAnchorPanel();
    };

    const getAnchorItems = () => ANCHORS[state.language] ?? ANCHORS.en;
    const IG_PREVIEW_COUNT = 4;

    const createIgEmbed = (url, hidden = false) => {
      const wrapper = document.createElement('div');
      wrapper.className = `anchor-ig-card${hidden ? ' hidden' : ''}`;
      const blockquote = document.createElement('blockquote');
      blockquote.className = 'instagram-media';
      blockquote.setAttribute('data-instgrm-permalink', url);
      blockquote.setAttribute('data-instgrm-version', '14');
      blockquote.style.margin = '0';
      wrapper.appendChild(blockquote);
      return wrapper;
    };

    function buildAnchorList() {
      const anchors = getAnchorItems();

      const list = document.getElementById('anchorList');
      list.innerHTML = '';

      anchors.forEach(item => {
        const card = document.createElement('div');
        card.className = 'anchor-card';
        card.id = item.id;

        const left = document.createElement('div');
        const title = document.createElement('h4');
        title.className = 'anchor-heading';
        title.textContent = item.title;
        const meta = document.createElement('div');
        meta.className = 'anchor-meta';
        meta.textContent = item.meta;
        const points = document.createElement('p');
        points.className = 'anchor-points';
        points.innerHTML = item.points.map(p => `â€¢ ${p}`).join('<br>');
        left.append(title, meta, points);

        const actions = document.createElement('div');
        actions.className = 'anchor-actions';
        const qrBtn = document.createElement('button');
        qrBtn.className = 'tiny-btn';
        qrBtn.type = 'button';
        qrBtn.textContent = getI18n('anchor.qr');
        qrBtn.addEventListener('click', () => showQRModal(item));
        const linkBtn = document.createElement('a');
        linkBtn.className = 'tiny-btn';
        linkBtn.href = `#${item.id}`;
        linkBtn.textContent = getI18n('anchor.locate');
        linkBtn.addEventListener('click', () => {
          openAnchorPanel();
          setTimeout(() => document.getElementById(item.id)?.scrollIntoView({ behavior: 'smooth', block: 'center' }), 80);
        });
        actions.append(qrBtn, linkBtn);

        card.append(left, actions);

        if (Array.isArray(item.igPosts) && item.igPosts.length) {
          const section = document.createElement('div');
          section.className = 'anchor-ig-section';
          const scroll = document.createElement('div');
          scroll.className = 'anchor-ig-scroll';
          item.igPosts.forEach((url, index) => {
            scroll.appendChild(createIgEmbed(url, index >= IG_PREVIEW_COUNT));
          });
          section.appendChild(scroll);

          if (item.igPosts.length > IG_PREVIEW_COUNT) {
            const toggleBtn = document.createElement('button');
            toggleBtn.type = 'button';
            toggleBtn.className = 'tiny-btn anchor-ig-toggle';
            toggleBtn.textContent = getI18n('anchor.showMore');
            toggleBtn.addEventListener('click', () => {
              const hiddenCards = scroll.querySelectorAll('.anchor-ig-card.hidden');
              const isExpanded = hiddenCards.length === 0;
              scroll.querySelectorAll('.anchor-ig-card').forEach((card, idx) => {
                card.classList.toggle('hidden', isExpanded && idx >= IG_PREVIEW_COUNT);
              });
              toggleBtn.textContent = isExpanded ? getI18n('anchor.showMore') : getI18n('anchor.showLess');
              setTimeout(() => window.instgrm?.Embeds?.process?.(), 120);
            });
            section.appendChild(toggleBtn);
          }

          card.appendChild(section);
        }

        list.appendChild(card);
      });

      setTimeout(() => window.instgrm?.Embeds?.process?.(), 120);
    }

    const showQRModal = (item) => {
      const base = window.location.href.split('#')[0];
      const targetUrl = `${base}#${item.id}`;
      const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=340x340&data=${encodeURIComponent(targetUrl)}`;
      document.getElementById('qrTitle').textContent = getI18n('qr.title');
      document.getElementById('qrSubtitle').textContent = item.title;
      document.getElementById('qrImage').src = qrUrl;
      document.getElementById('qrModal').classList.add('show');
    };

    const closeQRModal = () => {
      document.getElementById('qrModal').classList.remove('show');
    };

    const attachUIEvents = () => {
      document.getElementById('btn-crisis').addEventListener('click', () => applyMode('crisis'));
      document.getElementById('btn-hope').addEventListener('click', () => applyMode('hope'));

      document.getElementById('infoCollapseBtn').addEventListener('click', () => setInfoCollapsed(!state.infoCollapsed));
      document.getElementById('timelineCollapseBtn').addEventListener('click', () => setTimelineCollapsed(!state.timelineCollapsed));

      document.getElementById('yearSelect').addEventListener('change', (e) => {
        const y = Number(e.target.value);
        if (y) jumpToYear(y);
      });

      document.getElementById('anchorToggle').addEventListener('click', toggleAnchorPanel);
      document.getElementById('anchorCloseBtn').addEventListener('click', closeAnchorPanel);
      document.getElementById('qrCloseBtn').addEventListener('click', closeQRModal);
      document.getElementById('qrModal').addEventListener('click', (e) => {
        if (e.target.id === 'qrModal') closeQRModal();
      });

      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.addEventListener('click', () => applyLanguage(btn.dataset.lang));
      });
    };

    const configureControls = () => {
      const controls = state.world.controls();
      controls.autoRotate = true;
      controls.autoRotateSpeed = 0.8;
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
      controls.enablePan = true;
      controls.enableZoom = true;
      controls.enableRotate = true;
      controls.rotateSpeed = 0.8;

      let resumeHandle;
      const pauseRotate = () => { controls.autoRotate = false; clearTimeout(resumeHandle); };
      const resumeRotate = () => {
        clearTimeout(resumeHandle);
        resumeHandle = setTimeout(() => { controls.autoRotate = true; }, 2500);
      };

      controls.addEventListener('start', pauseRotate);
      controls.addEventListener('end', resumeRotate);
    };

    const prepareData = (data) => {
      state.events = (data.events || []).map((ev, idx) => {
        const dt = ev.date ? new Date(ev.date) : null;
        const year = ev.year ?? (dt ? dt.getFullYear() : null);
        const month = ev.month ?? (dt ? (dt.getMonth() + 1) : null);

        return {
          id: ev.id ?? `${ev.mode}-${year}-${month}-${idx}`,
          ...ev,
          year,
          month,
          lat: ev.coordinates?.lat,
          lng: ev.coordinates?.lng
        };
      }).filter(ev =>
        Number.isFinite(ev.lat) && Number.isFinite(ev.lng) &&
        Number.isFinite(ev.year) && Number.isFinite(ev.month)
      );

      if (data.config?.initial_view) state.initialView = data.config.initial_view;
    };

    const bootstrap = async () => {
      const uiLayer = document.getElementById('ui-layer');
      uiLayer.style.pointerEvents = 'none';

      playEntryOverlay();

      const savedLang = localStorage.getItem(LANG_STORAGE_KEY);
      const initialLang = savedLang === 'zh' ? 'zh' : 'en';
      applyLanguage(initialLang);

      const data = await fetchJSON('data.json');
      prepareData(data);

      await preloadImage(TEXTURE.day);
      await preloadImage(TEXTURE.bump).catch(() => {});
      await preloadImage(TEXTURE.specular).catch(() => {});

      state.world = Globe()(document.getElementById('globeViz'));
      state.world
        .globeImageUrl(TEXTURE.day)
        .backgroundColor('#000000')
        .pointAltitude(0.02)
        .pointRadius(0.6)
        .pointLabel(d => {
          const translated = getEventTranslation(d);
          return `<div style="padding:6px 8px;">${translated.title || ''}</div>`;
        })
        .pointColor(d => d.mode === 'crisis' ? COLORS.crisis : COLORS.hope)
        .onPointClick((d) => {
          // âœ… é»åœ°çƒé»ä½ï¼šåŒæ­¥å¹´ä»½ä¸‹æ‹‰/æœˆä»½/äº‹ä»¶
          state.currentYear = d.year;
          state.currentMonth = d.month;
          state.currentEventId = d.id;

          document.getElementById('yearSelect').value = String(d.year);

          renderMonths(d.year);
          highlightMonth(d.month);

          renderEvents(d.year, d.month);
          highlightEvent(d.id);

          showInfo(d);
        })
        .onGlobeClick(() => {
          document.getElementById('infoPanel').classList.remove('show');
          if (IS_MOBILE) setTimelineCollapsed(false);
        });

      if (typeof state.world.pointThreeObject === 'function') {
        state.world.pointThreeObject(buildPointObject).pointThreeObjectExtend(true);
      }

      configureControls();

      const mat = state.world.globeMaterial();
      mat.emissive = new THREE.Color('#000000');

      const texLoader = new THREE.TextureLoader();

      texLoader.load(TEXTURE.bump, (bumpTex) => {
        mat.bumpMap = bumpTex;
        mat.bumpScale = 0.08;
        mat.needsUpdate = true;
      }, undefined, () => {});

      texLoader.load(TEXTURE.specular, (specTex) => {
        mat.specularMap = specTex;
        mat.specular = new THREE.Color('#888888');
        mat.shininess = 6;
        mat.needsUpdate = true;
      }, undefined, () => {});

      attachUIEvents();
      createPulse();

      state.world.pointOfView({
        lat: state.initialView.lat,
        lng: state.initialView.lng,
        altitude: (QUALITY === 'mobile') ? state.initialView.altitude + 0.6 : state.initialView.altitude
      }, 0);

      renderPoints();
      refreshFiltersUI();

      const first = state.filtered[0];
      if (first) {
        state.currentYear = first.year;
        state.currentMonth = first.month;
        state.currentEventId = first.id;
        refreshFiltersUI();
        showInfo(first);
      }

      setInfoCollapsed(IS_MOBILE);
      setTimelineCollapsed(IS_MOBILE);

      applyMode(state.currentMode);

      uiLayer.style.pointerEvents = 'auto';

      if (window.location.hash) {
        const targetId = window.location.hash.replace('#', '');
        const el = document.getElementById(targetId);
        if (el) {
          openAnchorPanel();
          setTimeout(() => el.scrollIntoView({ behavior: 'smooth', block: 'center' }), 200);
        }
      }
    };

    bootstrap().catch(err => {
      console.error(err);
      alert(`${getI18n('misc.initFail')}: ${err.message}`);
    });
  </script>
</body>
</html>
